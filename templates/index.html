{% extends "layout.html" %}

{% block content %}
<h1>Temperature & Humidity Dashboard</h1>

<!-- CURRENT VALUES (from Flask) -->
<div style="display: flex; gap: 20px; margin-bottom: 20px;">
    <div class="metric">
        <b>Current Temperature:</b> {{ latest.Temperature }} °F
    </div>
    <div class="metric">
        <b>Current Humidity:</b> {{ latest.Humidity }} %
    </div>
</div>

<hr>

<h3>Visual Trend</h3>
<div class="chart-container">
    <canvas id="sensorChart"></canvas>
</div>

<hr>

<h3>Select Date Range</h3>
<form id="filterForm">
    Start:
    <input type="datetime-local" id="start">
    End:
    <input type="datetime-local" id="end">
    <button type="submit">Apply</button>
</form>

<hr>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h3>Recent Raw Data (Last 10)</h3>
    <a href="/download?start={{ request.args.get('start','') }}&end={{ request.args.get('end','') }}">
        Download Full CSV
    </a>
</div>

<table border="1" cellpadding="5" style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background: #eee;">
            <th>Time</th>
            <th>Temperature (°F)</th>
            <th>Humidity (%)</th>
        </tr>
    </thead>
    <tbody>
        {% for r in filtered[-10:]|reverse %}
        <tr>
            <td>{{ r.Time }}</td>
            <td>{{ r.Temperature }}</td>
            <td>{{ r.Humidity }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
let chart;

async function loadData() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;

    const url = `/data?start=${start}&end=${end}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
        return;
    }

    const labels = data.map(d => d.Time);
    const temperatures = data.map(d => d.Temperature);
    const humidities = data.map(d => d.Humidity);

    if (chart) chart.destroy();

    const ctx = document.getElementById("sensorChart");
    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Temperature (°F)",
                    data: temperatures,
                    borderColor: "red",
                    tension: 0.2
                },
                {
                    label: "Humidity (%)",
                    data: humidities,
                    borderColor: "blue",
                    tension: 0.2
                }
            ]
        }
    });
}

document.getElementById("filterForm").addEventListener("submit", function(e) {
    e.preventDefault();
    loadData();
});

loadData();
</script>
{% endblock %}
