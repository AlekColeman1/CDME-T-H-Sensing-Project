{% extends "layout.html" %}

{% block content %}
<h1>Temperature & Humidity Dashboard</h1>

<!-- CURRENT VALUES (from Flask) -->
<div style="display: flex; gap: 20px; margin-bottom: 20px;">
    <div class="metric">
  <b>Current Temperature:</b>
  <span id="liveTemp">{{ latest.Temperature }}</span> °F
</div>
<div class="metric">
  <b>Current Humidity:</b>
  <span id="liveHum">{{ latest.Humidity }}</span> %
</div>
</div>

<hr>

<h3>Visual Trend</h3>
<div class="chart-container">
    <canvas id="sensorChart"></canvas>
</div>

<hr>

<h3>Select Date Range</h3>
<form id="filterForm">
    Start:
    <input type="datetime-local" id="start">
    End:
    <input type="datetime-local" id="end">
    <button type="submit">Apply</button>
</form>

<hr>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h3>Recent Raw Data (Last 10)</h3>
    <a href="/download?start={{ request.args.get('start','') }}&end={{ request.args.get('end','') }}">
        Download Full CSV
    </a>
</div>

<table border="1" cellpadding="5" style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background: #eee;">
            <th>Time</th>
            <th>Temperature (°F)</th>
            <th>Humidity (%)</th>
        </tr>
    </thead>
    <tbody>
        {% for r in filtered[-10:]|reverse %}
        <tr>
            <td>{{ r.Time }}</td>
            <td>{{ r.Temperature }}</td>
            <td>{{ r.Humidity }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
let chart;
let liveMode = true;
const MAX_POINTS = 100;

/* --------------------
   LIVE TOP READINGS
-------------------- */
async function updateLiveReadings() {
    try {
        const res = await fetch("/api/live");
        const data = await res.json();
        if (!data.Time) return;

        document.getElementById("liveTemp").textContent =
            data.Temperature.toFixed(1);
        document.getElementById("liveHum").textContent =
            data.Humidity.toFixed(1);
    } catch (e) {
        console.error("Live readings error", e);
    }
}

/* --------------------
   INITIAL LIVE GRAPH
-------------------- */
async function loadLiveGraph() {
    const res = await fetch("/api/recent?limit=" + MAX_POINTS);
    const data = await res.json();
    if (!data.length) return;

    const ctx = document.getElementById("sensorChart");

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.map(d => d.Time),
            datasets: [
                {
                    label: "Temperature (°F)",
                    data: data.map(d => d.Temperature),
                    borderColor: "red",
                    tension: 0.2
                },
                {
                    label: "Humidity (%)",
                    data: data.map(d => d.Humidity),
                    borderColor: "blue",
                    tension: 0.2
                }
            ]
        },
        options: {
            animation: false
        }
    });
}

/* --------------------
   LIVE GRAPH UPDATES
-------------------- */
async function updateLiveGraph() {
    if (!liveMode || !chart) return;

    const res = await fetch("/api/live");
    const p = await res.json();
    if (!p.Time) return;

    const labels = chart.data.labels;
    if (labels[labels.length - 1] === p.Time) return;

    labels.push(p.Time);
    chart.data.datasets[0].data.push(p.Temperature);
    chart.data.datasets[1].data.push(p.Humidity);

    if (labels.length > MAX_POINTS) {
        labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
    }

    chart.update("none");
}

/* --------------------
   FILTERED GRAPH
-------------------- */
async function loadFilteredData() {
    liveMode = false;

    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;

    const res = await fetch(`/data?start=${start}&end=${end}`);
    const data = await res.json();
    if (!data.length) return;

    chart.data.labels = data.map(d => d.Time);
    chart.data.datasets[0].data = data.map(d => d.Temperature);
    chart.data.datasets[1].data = data.map(d => d.Humidity);
    chart.update();
}

/* --------------------
   EVENT HANDLERS
-------------------- */
document.getElementById("filterForm").addEventListener("submit", e => {
    e.preventDefault();
    loadFilteredData();
});

/* --------------------
   START EVERYTHING
-------------------- */
loadLiveGraph();
updateLiveReadings();

setInterval(updateLiveReadings, 3000); // always live
setInterval(updateLiveGraph, 3000);    // only if liveMode
</script>
{% endblock %}
